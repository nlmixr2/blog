---
title: mceta -- Monte-Carlo focei?
author: Matthew Fidler
date: '2025-09-28'
slug: []
categories: [nlmixr2 mceta]
tags: []
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## nlmixr2 4.0 `mceta`

Two of popular algorithms for fitting nonlinear fixed effects models
in pharmacometrics are first order conditional estimation (with
interaction), sometimes called focei.  This is often considered a
classical estimation method

As time progressed, Monte-Carlo methods started being used, such as
stochastic approximation estimation-maximization (saem). This samples
over the likelihood service also trying to figure out the best fit
based on randomly sampling the likelihood.

The new feature I am discussing is `mceta` for `focei`, which combines
the Monte-Carlo sampling with focei.

## What is `mceta`

One of the most important parts of getting a good model in non-linear
mixed effects models is to choose reasonable estimates for the
model. This is something pharmacometricians do to get the best and
most reasonable model for the data.  This can take several iterations
to get right.

Usually we set things like the population estimates of the model, and
the variances/covariance of between subject variability as well as the
residual errors.

One thing you can do in both `nlmixr2` and `NONMEM` is to set the
initial between subject variability estimates (which we will call
`eta`s) to get an even better initial estimate for the problem.

While true, this is infrequently done by pharmacometricians.
Typically they accept the defaults of the algorithm and hope for a
good final fit.

However with `mceta`, we can change the algorithm's default.  In
`nlmixr2` these options are:

- `mceta=-1` -- Use the best eta estimate from the last iteration
  (`nlmixr2`'s default, and not available in NONMEM at the time of
  this writing)

- `mceta=0` -- Start at all `eta`s equal 0 (NONMEM's default)

- `mceta=1` -- Try the `eta` at the last best fit estimate as well as
  the `eta`s set to zero, and start the optimization of that
  individual at the `eta` with the lowest objective function.

- `mceta=N` -- Try the `etas` as described in `mceta=1` and then take
  `N-1` random multivariate normal samples (assuming the specified
  between subject variability covariance matrix, `omega`, is
  true). Start the optimization at the `eta` value with the smallest
  individual objective function.

At values of `mceta > 1`, the `focei` algorithm becomes a Monte-Carlo
method (though not a `mcmc` method).

This means that some of the strengths and robustness of the new
algorithms can be achieved by increasing the `mceta` value; of course,
this also means that the estimation method is non-deterministic too.

This extra feature was added to help include `focei` linearization of
models (which I helped Omar Elashkar work on during his summer
internship).

In general, this helps with the `focei` linearization (in both `nlmixr2`
and in `NONMEM`) but it can also help find better models with ODEs (at
the cost of computation time).

I have not seen much discussion about this feature, though I have
heard it mentioned a couple of times by some analysts.  I think it can
help in complex analyses where you want to use `focei`.

## Simple implementation example

To implement mceta, you simply need to put it in the focei-related
methods like `focei`, `foce`, `laplace`, and `agq`.  For
simplicity sake, I will add it to the thepohylline example:

```{r theo}
library(nlmixr2)
one.cmt <- function() {
  ini({
    tka <- 0.45 # Log Ka
    tcl <- log(c(0, 2.7, 100)) # Log Cl
    tv <- 3.45; label("log V")
    eta.ka ~ 0.6
    eta.cl ~ 0.3
    eta.v ~ 0.1
    add.sd <- 0.7
  })
  model({
    ka <- exp(tka + eta.ka)
    cl <- exp(tcl + eta.cl)
    v <- exp(tv + eta.v)
    linCmt() ~ add(add.sd)
  })
}

fit <- nlmixr(one.cmt, theo_sd, est="focei",
              control=list(print=0, mceta=5))

print(fit)
```

In this very simplistic case, there was not a huge difference, however
with complex models this could make the difference between a good
solution and a poor solution.

Happy modeling!


Roulette wheel originally <a href="http://www.freepik.com">designed by
macrovector / Freepik</a> with modifications for this post.
