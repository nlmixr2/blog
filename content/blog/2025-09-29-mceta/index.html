---
title: mceta -- Monte-Carlo focei?
author: Matthew Fidler
date: '2025-09-28'
slug: []
categories: [nlmixr2 mceta]
tags: []
---



<div id="nlmixr2-4.0-mceta" class="section level2">
<h2>nlmixr2 4.0 <code>mceta</code></h2>
<p>Two of popular algorithms for fitting nonlinear fixed effects models
in pharmacometrics are first order conditional estimation (with
interaction), sometimes called focei. This is often considered a
classical estimation method</p>
<p>As time progressed, Monte-Carlo methods started being used, such as
stochastic approximation estimation-maximization (saem). This uses
Mote-Carlo Methods to try to find the maximum expectation of the
nonlinear-mixed effects model.</p>
<p>The new feature I am discussing is <code>mceta</code> for <code>focei</code>, which combines
the Monte-Carlo sampling with focei.</p>
</div>
<div id="what-is-mceta" class="section level2">
<h2>What is <code>mceta</code></h2>
<p>One of the most important parts of getting a good model in non-linear
mixed effects models is to choose reasonable estimates for the
model. This is something pharmacometricians do to get the best and
most reasonable model for the data. This can take several iterations
to get right.</p>
<p>Usually we set things like the population estimates of the model, and
the variances/covariance of between subject variability as well as the
residual errors.</p>
<p>One thing you can do in both <code>nlmixr2</code> and <code>NONMEM</code> is to set the
initial between subject variability estimates (which we will call
<code>eta</code>s) to get an even better initial estimate for the problem.</p>
<p>While true, this is infrequently done by pharmacometricians.
Typically they accept the defaults of the algorithm and hope for a
good final fit.</p>
<p>However with <code>mceta</code>, we can change the algorithm’s default. In
<code>nlmixr2</code> these options are:</p>
<ul>
<li><p><code>mceta=-1</code> – Use the best eta estimate from the last iteration
(<code>nlmixr2</code>’s default, and not available in NONMEM at the time of
this writing)</p></li>
<li><p><code>mceta=0</code> – Start at all <code>eta</code>s equal 0 (NONMEM’s default)</p></li>
<li><p><code>mceta=1</code> – Try the <code>eta</code> at the last best fit estimate as well as
the <code>eta</code>s set to zero, and start the optimization at the <code>eta</code> with
the lowest objective function.</p></li>
<li><p><code>mceta=N</code> – Try the <code>etas</code> as described in <code>mceta=1</code> and then take
<code>N-1</code> random multivariate normal samples (assuming the specified
between subject variability covariance matrix, <code>omega</code>, is
true). Start the optimization at the <code>eta</code> value with the smallest
individual objective function.</p></li>
</ul>
<p>At values of <code>mceta &gt; 1</code>, the <code>focei</code> algorithm becomes a Monte-Carlo
method (though not a <code>mcmc</code> method).</p>
<p>This means that some of the strengths and robustness of the new
algorithms can be achieved by increasing the <code>mceta</code> value; of course,
this also means that the estimation method is non-deterministic too.</p>
<p>This extra feature was added to help include <code>focei</code> linearization of
models (which I helped Omar Elashkar work on during his summer
internship).</p>
<p>In general, this helps with the <code>focei</code> linearization (in both <code>nlmixr2</code>
and in <code>NONMEM</code>) but it can also help find better models with ODEs (at
the cost of computation time).</p>
<p>I have not seen much discussion about this feature, though I have
heard it mentioned a couple of times by some analysts. I think it can
help in complex analyses where you want to use <code>focei</code>.</p>
</div>
<div id="simple-implementation-example" class="section level2">
<h2>Simple implementation example</h2>
<p>To implement mceta, you simply need to put it in the focei-related
methods like <code>focei</code>, <code>foce</code>, <code>laplace</code>, and <code>agq</code>. For
simplicity sake, I will add it to the thepohylline example:</p>
<pre class="r"><code>library(nlmixr2)</code></pre>
<pre><code>## ── Attaching packages ───────────────────────────────────────────────────────── nlmixr2 4.0.1 ──</code></pre>
<pre><code>## ✔ lotri         1.0.2          ✔ monolix2rx    0.0.6     
## ✔ nlmixr2data   2.0.9          ✔ nlmixr2lib    0.3.0.9000
## ✔ nlmixr2est    4.1.0.9000     ✔ nlmixr2rpt    0.2.1     
## ✔ nlmixr2extra  3.0.3          ✔ nonmem2rx     0.1.8     
## ✔ nlmixr2plot   3.0.3          ✔ posologyr     1.2.8     
## ✔ rxode2        4.1.0.9000     ✔ shinyMixR     0.5.2     
## ✔ babelmixr2    0.1.9          ✔ xpose.nlmixr2 0.4.1     
## ✔ ggPMX         1.3.2</code></pre>
<pre><code>## ── Optional Packages Loaded/Ignored ─────────────────────────────────────────── nlmixr2 4.0.1 ──</code></pre>
<pre><code>## ✔ babelmixr2        ✔ nonmem2rx    
## ✔ ggPMX             ✔ posologyr    
## ✔ monolix2rx        ✔ shinyMixR    
## ✔ nlmixr2lib        ✔ xpose.nlmixr2
## ✔ nlmixr2rpt</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────────────────────────── nlmixr2conflicts() ──
## ✖ rxode2::boxCox()     masks nlmixr2est::boxCox()
## ✖ rxode2::yeoJohnson() masks nlmixr2est::yeoJohnson()</code></pre>
<pre class="r"><code># For reproducibility, set the seed for R and rxode2
set.seed(42)
rxSetSeed(42)

one.cmt &lt;- function() {
  ini({
    tka &lt;- 0.45 # Log Ka
    tcl &lt;- log(c(0, 2.7, 100)) # Log Cl
    tv &lt;- 3.45; label(&quot;log V&quot;)
    eta.ka ~ 0.6
    eta.cl ~ 0.3
    eta.v ~ 0.1
    add.sd &lt;- 0.7
  })
  model({
    ka &lt;- exp(tka + eta.ka)
    cl &lt;- exp(tcl + eta.cl)
    v &lt;- exp(tv + eta.v)
    linCmt() ~ add(add.sd)
  })
}

fit &lt;- nlmixr(one.cmt, theo_sd, est=&quot;focei&quot;,
              control=list(print=0, mceta=5))</code></pre>
<pre><code>## ℹ parameter labels from comments are typically ignored in non-interactive mode</code></pre>
<pre><code>## ℹ Need to run with the source intact to parse comments</code></pre>
<pre><code>## calculating covariance matrix
## [====|====|====|====|====|====|====|====|====|====] 0:00:00 
## done</code></pre>
<pre><code>## → Calculating residuals/tables</code></pre>
<pre><code>## ✔ done</code></pre>
<pre><code>## → compress origData in nlmixr2 object, save 5952</code></pre>
<pre><code>## → compress parHistData in nlmixr2 object, save 5088</code></pre>
<pre class="r"><code>print(fit)</code></pre>
<pre><code>## ── nlmixr² FOCEi (outer: nlminb) ──
## 
##          OBJF      AIC      BIC Log-likelihood Condition#(Cov) Condition#(Cor)
## FOCEi 116.806 373.4058 393.5854      -179.7029        68.43734        9.370183
## 
## ── Time (sec $time): ──
## 
##            setup optimize covariance table compress   other
## elapsed 0.001566 0.355792   0.355792 0.073    0.006 2.51685
## 
## ── Population Parameters ($parFixed or $parFixedDf): ──
## 
##        Parameter  Est.     SE %RSE Back-transformed(95%CI) BSV(CV%) Shrink(SD)%
## tka              0.469  0.195 41.6        1.6 (1.09, 2.34)     70.7      2.04% 
## tcl               1.01 0.0751 7.41       2.75 (2.38, 3.19)     26.7      3.90% 
## tv         log V  3.46 0.0436 1.26       31.8 (29.2, 34.6)     14.1      10.7% 
## add.sd           0.694                               0.694                     
##  
##   Covariance Type ($covMethod): r,s
##   No correlations in between subject variability (BSV) matrix
##   Full BSV covariance ($omega) or correlation ($omegaR; diagonals=SDs) 
##   Distribution stats (mean/skewness/kurtosis/p-value) available in $shrink 
##   Information about run found ($runInfo):
##    • gradient problems with initial estimate and covariance; see $scaleInfo 
##    • last objective function was not at minimum, possible problems in optimization 
##    • ETAs were reset to zero during optimization; (Can control by foceiControl(resetEtaP=.)) 
##    • initial ETAs were nudged; (can control by foceiControl(etaNudge=., etaNudge2=)) 
##   Censoring ($censInformation): No censoring
##   Minimization message ($message):  
##     relative convergence (4) 
## 
## ── Fit Data (object is a modified tibble): ──
## # A tibble: 132 × 22
##   ID     TIME    DV  PRED    RES   WRES IPRED   IRES  IWRES CPRED   CRES  CWRES
##   &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 1      0     0.74  0     0.74   1.07   0     0.74   1.07   0     0.74   1.07 
## 2 1      0.25  2.84  3.28 -0.437 -0.525  3.85 -1.01  -1.45   3.49 -0.654 -0.744
## 3 1      0.57  6.57  5.85  0.721  0.672  6.79 -0.216 -0.311  6.16  0.405  0.344
## # ℹ 129 more rows
## # ℹ 10 more variables: eta.ka &lt;dbl&gt;, eta.cl &lt;dbl&gt;, eta.v &lt;dbl&gt;, depot &lt;dbl&gt;,
## #   central &lt;dbl&gt;, ka &lt;dbl&gt;, cl &lt;dbl&gt;, v &lt;dbl&gt;, tad &lt;dbl&gt;, dosenum &lt;dbl&gt;</code></pre>
<p>In this very simplistic case, there was not a huge difference, however
with complex models this could make the difference between a good
solution and a poor solution.</p>
<p>Happy modeling!</p>
<p>Roulette wheel originally <a href="http://www.freepik.com">designed by
macrovector / Freepik</a> with modifications for this post.</p>
</div>
